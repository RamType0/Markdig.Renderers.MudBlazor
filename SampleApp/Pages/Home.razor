@page "/"
@using Markdig
@using Markdig.Renderers.MudBlazor
@using Markdig.Renderers.MudBlazor.Components
@using Markdig.Renderers.RazorComponent
@using Markdig.Renderers.RazorComponent.Components
@using Markdig.Renderers.RazorComponent.Kroki
@using Microsoft.AspNetCore.Components.Rendering
@using System.Globalization
@using Vega.Embed

<PageTitle>Home</PageTitle>

<MudGrid>
    <MudItem xs="6">
        <MudTextField Label="Markdown" @bind-Value="@markdownText" AutoGrow AutoFocus Immediate />
        <MudCheckBox Label="Use MudBlazor" @bind-Value="@useMudBlazor" />
        <MudCheckBox Label="Use Kroki" @bind-Value="@useKroki" />
    </MudItem>
    <MudItem xs="6">
        <MudField Label="Preview">
            <CascadingVegaEmbedCodeBlockOptions VegaEmbedOptions="@VegaEmbedOptions">
                <ChildContent>
                    <CascadingCodeBlockOptions>
                        <OpenCodeBlockContent>
                            <MudProgressCircular Indeterminate />
                        </OpenCodeBlockContent>
                        <ChildContent>
                            <MudMarkdown Value="@markdownText" Pipeline="@GetPipeline()" />
                        </ChildContent>
                    </CascadingCodeBlockOptions>
                </ChildContent>
                <ErrorContent Context="exception">
                    <MudAlert Severity="Severity.Error">
                        @exception.Message
                    </MudAlert>
                </ErrorContent>
            </CascadingVegaEmbedCodeBlockOptions>

        </MudField>
    </MudItem>
</MudGrid>

@code{
    static EmbedOptions VegaEmbedOptions { get; } = new()
    {
        FormatLocale = D3FormatLocale.FromNumberFormatInfo(CultureInfo.CurrentUICulture.NumberFormat),
        TimeFormatLocale = D3TimeFormatLocale.FromDateTimeFormatInfo(CultureInfo.CurrentUICulture.DateTimeFormat),
    };
    bool useMudBlazor = true;

    bool useKroki = true;


    MarkdownPipeline GetPipeline()
    {
        var pipelineBuilder = new MarkdownPipelineBuilder().UseAdvancedExtensions();

        if (useMudBlazor)
        {
            pipelineBuilder.UseMudBlazor();
        }
        if (useKroki)
        {
            pipelineBuilder.UseKroki();
        }
        return pipelineBuilder.Build();
    }
}